<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>查詢結果 - 線上減重班</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css' rel='stylesheet' />

  <style>
    body {
      font-family: 'Verdana', 'Hiragino Sans', 'Meiryo', sans-serif;
      height: 100vh; /* 確保 footer 定位 */
    }

    /* 確保 FullCalendar 和圖表容器有寬度 */
    #table_div, #chart_div, #calendar_div, #drawContent {
      width: 99%;
      position: relative;
      font-size: 1.5vw;
      z-index: 1;
    }

    .sticky-note {
      position: absolute;
      width: 20%;
      margin: 10px;
      padding: 10px;
      font-family: "Comic Sans MS", cursive, sans-serif;
      overflow: hidden; /* 防止內容溢出 */
      word-wrap: break-word;
    }

    /* 設定背景顏色和陰影 */
    .sticky-note-yellow { background-color: #fffc9e; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2); }
    .sticky-note-pink { background-color: #ff9ee5; box-shadow: -5px -5px 10px rgba(0, 0, 0, 0.2); }
    .sticky-note-green { background-color: #d0f0c0; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2); }
    .sticky-note-purple { background-color: #e6e6fa; box-shadow: -5px -5px 10px rgba(0, 0, 0, 0.2); }
    .sticky-note-blue { background-color: #add8e6; box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2); }
    .sticky-note-orange { background-color: #ffa500; box-shadow: -5px -5px 10px rgba(0, 0, 0, 0.2); }

    .sticky-note:hover {
      transform: scale(1.1) !important; /* 強制覆蓋行內樣式 */
      transition: transform 0.3s ease-in-out;
      z-index: 10;
    }

    table { width: 100%; border-collapse: collapse; }
    th { top: 0; background-color: #f2f2f2; }
    th, td { text-align: left; padding: 8px; border: 1px solid #ddd; }

    header {
      z-index: 2;
      background-color: #E9B2BD;
      position: fixed;
      top: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    main {
      padding-top: 220px; /* 預留 header 高度 */
      padding-bottom: 50px;
      min-height: 100vh;
    }

    footer {
      position: fixed;
      z-index: 2;
      width: 100%;
      background-color: white;
      height: 30px;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #b7b7b7;
    }

    nav { padding: 1vh; text-align: center; }
    .welcome { padding: 1.5vh; font-size: 16px; }

    .imgGroup, .imgCoach { display: flex; flex-wrap: wrap; justify-content: center; }
    .imgGroup img, .imgCoach img {
      padding: 5px;
      width: 150px;
      height: 150px;
      object-fit: contain;
      border-radius: 10px;
    }

    #chart_sec p {
      color: #E9B2BD;
      padding: 3vh 0 0 0;
      font-size: 20px;
      text-align: center;
    }

    input.btn.btn-primary {
      padding: 10px 20px;
      border-radius: 10px;
      margin: 5px;
    }

    #drawContent { height: 600px; position: relative; display: none; }
    #tips { font-size: 18px; color: #E9B2BD; padding: 10px; text-align: center; }

    /* RWD 調整 */
    @media (max-width: 768px) {
      main { padding-top: 280px; }
      .sticky-note { width: 40%; font-size: 12px; }
      .imgGroup img, .imgCoach img { width: 100px; height: 100px; }
      #drawContent { height: 400px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="welcome container">
      <div class="row">
        <div class="col-md-12">
          <p style="white-space: nowrap;">學號：<span id="disp_id"></span>，您好</p>
          <p style="white-space: nowrap;">可以點下方功能查詢心得與簽到狀況喔～查詢要一下子時間</p>
          <small class="text-muted" style="display: block; text-align: right;">
            貼心提醒：簽到計算從 <span id="disp_dateRange"></span>
          </small>
        </div>
      </div>
    </div>
    <nav id="nav-menu">
      <input type="button" value="全部心得查詢" onclick="getData()" class="btn btn-primary">
      <input type="button" value="這個月的累積次數" onclick="drawChart()" class="btn btn-primary">
      <input type="button" value="簽到細項行事曆" onclick="drawCalendar()" class="btn btn-primary">
      <input type="button" value="給你愛的小紙條" onclick="drawSticyNote()" class="btn btn-primary">
      <input type="button" value="登出" onclick="logout()" class="btn btn-danger" style="float: right;">
    </nav>
  </header>

  <main class="container-fluid">
    <div id="loading" style="text-align:center; display:none; padding: 20px;">
        <span class="glyphicon glyphicon-refresh glyphicon-spin"></span> 資料讀取中...
    </div>

    <small id="tips"></small>
    
    <section class="table-responsive" id="table_div"></section>

    <section id="chart_sec" style="display:none;">
      <div id="chart_div" style="height: 300px;"></div>
      <p id="signLog">簽到次數 里程碑</p>
      <div class="imgGroup" id="img_div"></div>
      <div class="imgCoach" id="imgCoach_div"></div>
    </section>

    <section id="calendar_sec" style="display:none;">
      <div style="text-align: right; padding: 10px;">
        <a href="#" target="_blank" id="signSheetUrlLink" style="color:#E9B2BD; font-size: 1.5rem; display:none;">補簽點這裡</a>
      </div>
      <div id="calendar_div"></div>
    </section>

    <section id="drawContent"></section>
  </main>

  <footer>
    <div id="footer_div">
      <p>Copyright © 2023 Artemis線上減重班. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js'></script>

  <script type="text/javascript">
    // ==========================================
    // 請填入您的 GAS Web App URL
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxE5Wrqr_uPvuHZ6HhE6s3fWfh9j7QX5et4ANiI5SXXcH0_HS9ZL8OUon2B-Jrmd3eA/exec"; 

    // 全域變數
    let userData = null;
    let userId = "";

    google.charts.load('current', { 'packages': ['bar'] });

    // 頁面載入初始化
    window.addEventListener('load', function() {
      // 1. 檢查登入狀態
      const storedData = sessionStorage.getItem('userData');
      userId = sessionStorage.getItem('userId');

      if (!storedData || !userId) {
        alert("請先登入！");
        window.location.href = "index.html";
        return;
      }

      userData = JSON.parse(storedData);

      // 2. 填入基本資料
      document.getElementById('disp_id').innerText = userData.idName || userId;
      document.getElementById('disp_dateRange').innerText = userData.dateRangeText || "";
      
      // 設定補簽連結
      if (userData.signSheetUrl) {
        const link = document.getElementById('signSheetUrlLink');
        link.href = userData.signSheetUrl;
        link.style.display = 'inline-block';
      }

      // 預設隱藏所有區塊
      divInit();
    });

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    function divInit() {
      $("#table_div").hide();
      $("#chart_sec").hide();
      $("#calendar_sec").hide();
      $("#drawContent").hide();
      $("#tips").html(""); // 清空提示
      $("#loading").hide();
    }

    function showLoading() {
      $("#loading").show();
      $('input[type="button"]').prop('disabled', true);
    }

    function hideLoading() {
      $("#loading").hide();
      $('input[type="button"]').prop('disabled', false);
    }

    // 建構查詢參數
    function getParams(op, filter = "conditional") {
      const params = new URLSearchParams({
        op: op,
        id: userId,
        sheetId: userData.sheetId, // 從登入資料取得 sheetId
        filter: filter
      });
      return GAS_URL + "?" + params.toString();
    }

    // ================= 功能 1: 全部心得查詢 =================
    function getData() {
      divInit();
      showLoading();

      fetch(getParams("getGsData", "ALL"))
        .then(res => res.json())
        .then(data => {
          drawTable(data);
          $("#table_div").show();
        })
        .catch(err => alert("讀取失敗：" + err))
        .finally(() => hideLoading());
    }

    function drawTable(obj) {
      if (!obj || obj.length === 0) {
        document.getElementById('table_div').innerHTML = "<h3 class='text-center'>查無資料</h3>";
        return;
      }

      let table = '<table class="table table-striped table-bordered">';
      // 表頭
      table += '<thead><tr>';
      for (let key in obj[0]) {
        table += '<th class="bg-primary">' + key + '</th>';
      }
      table += '</tr></thead><tbody>';

      // 內容
      obj.forEach(row => {
        table += '<tr>';
        for (let key in row) {
          let style = (key == "校長留言板") ? "style='color:blue; font-weight:bold;'" : "";
          table += `<td ${style}>${row[key]}</td>`;
        }
        table += '</tr>';
      });
      table += '</tbody></table>';
      document.getElementById('table_div').innerHTML = table;
    }

    // ================= 功能 2: 這個月的累積次數 (圖表 + 勳章) =================
    function drawChart() {
      divInit();
      showLoading();
      $("#chart_sec").show();

      // 同時發送三個請求 (提示訊息、圖表數據、圖片列表)
      Promise.all([
        fetch(getParams("calCoachCount")).then(r => r.json()),
        fetch(getParams("getEvents")).then(r => r.json()),
        fetch(getParams("getBadges")).then(r => r.json())
      ]).then(([coachData, eventsData, badgesData]) => {
        
        // 1. 顯示提示
        document.getElementById('tips').innerHTML = coachData.message;

        // 2. 繪製圖表
        drawBarChart(eventsData);

        // 3. 繪製勳章圖片
        renderBadges(badgesData);

      }).catch(err => console.error(err))
        .finally(() => hideLoading());
    }

    function drawBarChart(rows) {
      // 過濾數據：只計算當前使用者的資料 (雖然 API 已過濾，但圖表邏輯保留原樣較安全)
      let total = 0;
      let dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', '項目');
      dataTable.addColumn('number', '次數');

      // 這裡簡化邏輯，直接算總數
      total = rows.length;
      
      // 為了配合原有的 Bar Chart 格式，我們建立兩筆資料：個人與總計
      dataTable.addRow([userData.idName || userId, 0]); // 佔位，避免空圖表
      dataTable.addRow(['累計簽到數', total]);

      let options = {
        chart: {
          title: '線上減重班',
          subtitle: '這個月累積簽到數',
        },
        bars: 'horizontal',
        bar: { groupWidth: "60%" },
        height: 300,
        legend: { position: 'none' }
      };

      let chart = new google.charts.Bar(document.getElementById('chart_div'));
      chart.draw(dataTable, google.charts.Bar.convertOptions(options));
    }

    function renderBadges(badges) {
      let imgHtml = "";
      let coachHtml = "";

      badges.forEach(badge => {
        // 根據後端回傳的 type 分類
        let imgTag = `<img src="${badge.src}" alt="${badge.alt}" title="${badge.alt}">`;
        
        if (badge.type === 'coach') {
          coachHtml += imgTag;
        } else {
          imgHtml += imgTag;
        }
      });

      document.getElementById('img_div').innerHTML = imgHtml;
      document.getElementById('imgCoach_div').innerHTML = coachHtml;
    }

    // ================= 功能 3: 簽到細項行事曆 =================
    function drawCalendar() {
      divInit();
      showLoading();
      $("#calendar_sec").show();
      $("#tips").html("載入行事曆中...");

      $('#calendar_div').fullCalendar('destroy');
      $('#calendar_div').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,listWeek'
        },
        height: 'auto',
        events: function(start, end, timezone, callback) {
          fetch(getParams("getEvents"))
            .then(res => res.json())
            .then(events => {
              callback(events);
              hideLoading();
              $("#tips").html("");
            })
            .catch(err => {
              alert("無法載入行事曆");
              hideLoading();
            });
        }
      });
    }

    // ================= 功能 4: 給你愛的小紙條 =================
    function drawSticyNote() {
      divInit();
      showLoading();
      
      const container = document.getElementById('drawContent');
      container.style.border = "1px solid #ccc";
      container.style.display = "block"; // 必須先顯示才能計算寬高
      
      fetch(getParams("getStickyNotes"))
        .then(res => res.json())
        .then(notes => {
          let html = "";
          
          if(notes.length === 0) {
            html = "<h3 class='text-center' style='padding-top:100px;'>目前沒有小紙條喔</h3>";
          } else {
            notes.forEach(note => {
              let content = note.content;
              if (content.length > 100) content = content.substring(0, 100) + "...";
              
              html += `<div class="sticky-note sticky-note-${note.color}">
                        ${content}
                        <br><br>
                        <small style="float:right;">by ${note.name}</small>
                      </div>`;
            });
          }
          
          container.innerHTML = html;
          
          // 計算隨機位置
          // 因為圖片尚未載入，文字高度不固定，使用 setTimeout 確保渲染後計算
          setTimeout(() => {
            const width = $(container).width();
            const height = $(container).height();
            
            $(".sticky-note").each(function() {
              const myW = $(this).outerWidth();
              const myH = $(this).outerHeight();
              
              const maxLeft = width - myW;
              const maxTop = height - myH;
              
              const randomLeft = Math.max(0, Math.random() * maxLeft);
              const randomTop = Math.max(0, Math.random() * maxTop);
              const randomAngle = (Math.random() * 20) - 10; // -10deg ~ 10deg

              $(this).css({
                "top": randomTop + "px",
                "left": randomLeft + "px",
                "transform": "rotate(" + randomAngle + "deg)"
              });
            });
            hideLoading();
          }, 100);

        })
        .catch(err => {
          alert("讀取小紙條失敗");
          hideLoading();
        });
    }
  </script>
</body>
</html>
