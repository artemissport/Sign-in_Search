<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>線上減重班 - 登入</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
  
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <h1 class="text-center">線上減重班</h1>
    <h2 class="text-center">簽到查詢</h2>
  </header>
  
  <main>
    <form id="loginForm">
      <label for="id">手機號碼:</label>
      <input type="text" id="id" name="id" placeholder="請輸入手機號碼" required="required">
      <small class="form-text text-muted">例：0912345678</small>
      <button type="submit" id="submitBtn" class="btn btn-primary">查詢</button>
      
      <div id="error-msg" style="color: red; display: none; margin-top: 10px; font-size: 1.2rem;"></div>
    </form>
  </main>
  
  <footer>
    <p>Copyright © 2023 Artemis線上減重班. All rights reserved.</p>
  </footer>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  
  <script type="text/javascript">
    // ==========================================
    // 【重要】請在這裡填入您 "最新部署" 的 GAS Web App URL
    // 網址結尾通常是 /exec
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyIVxRaUyvXhrYRyCPq56sqtM9fCGNE3AwWz_drKvpxofSaIg5oTHoGzR0JOfEroL1m/exec"; 

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault(); // 阻止表單預設跳頁行為
      
      const submitBtn = document.getElementById('submitBtn');
      const errorMsg = document.getElementById('error-msg');
      const idInput = document.getElementById('id').value.trim();

      // 簡單防呆檢查
      if(!GAS_URL || GAS_URL.includes("請將你的GAS網址貼在這裡")) {
        alert("請先在 index.html 程式碼中設定正確的 GAS_URL！");
        return;
      }

      // 鎖定按鈕，避免重複點擊
      submitBtn.setAttribute('disabled', true);
      submitBtn.innerText = "查詢中...";
      errorMsg.style.display = 'none';

      // 呼叫 GAS API
      fetch(`${GAS_URL}?op=checkLogin&id=${idInput}`)
        .then(response => {
          // 檢查 HTTP 狀態碼
          if (!response.ok) {
            throw new Error(`伺服器回應錯誤 (${response.status})`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            // 1. 登入成功：將資料存入 SessionStorage (瀏覽器暫存)
            sessionStorage.setItem('userId', idInput);
            sessionStorage.setItem('userData', JSON.stringify(data));
            
            // 2. 跳轉到結果頁
            window.location.href = 'result.html';
          } else {
            // 登入失敗 (後端回傳找不到學號或其他錯誤)
            throw new Error(data.message || '找不到此號碼');
          }
        })
        .catch(err => {
          console.error("登入錯誤:", err);
          
          let showMessage = "登入失敗：" + err.message;
          
          // 如果解析 JSON 失敗，通常代表 GAS 發生錯誤回傳了 HTML 報錯頁面
          if (err.name === 'SyntaxError') {
              showMessage = "連線錯誤：伺服器回傳格式不正確。請確認 GAS 是否已部署為最新版本，且權限設為「所有人」。";
          }
          
          errorMsg.innerText = showMessage;
          errorMsg.style.display = 'block';
          
          // 解鎖按鈕
          submitBtn.removeAttribute('disabled');
          submitBtn.innerText = "查詢";
        });
    });
  </script>
</body>

</html>
