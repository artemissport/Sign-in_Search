// --- 修改後的 loadCalendar ---
function loadCalendar() {
  const calendarEl = document.getElementById('calendar');

  // 如果行事曆已經初始化過，就不重新抓資料，直接顯示
  // 但因為我們是切換 Tab，FullCalendar 可能會因為隱藏而破圖，所以需要 updateSize
  if (calendarInstance) {
    // 稍微延遲一下，確保 DOM display:block 已經生效後再 resize
    setTimeout(() => {
        calendarInstance.updateSize(); 
    }, 100);
    return;
  }

  showContentLoader(true);
  
  // 使用 fetch 從後端抓資料
  fetch(`${GAS_API_URL}?op=getCalendar&sheetId=${currentUser.sheetId}&id=${currentUser.id}`)
    .then(r => r.json())
    .then(res => {
        showContentLoader(false);
        
        // 檢查後端回傳資料
        if (!res.success) {
            Swal.fire('錯誤', '無法讀取行事曆資料', 'error');
            return;
        }

        // 初始化 FullCalendar
        calendarInstance = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 'auto',
          locale: 'zh-tw', // 設定為中文
          headerToolbar: {
            left: 'prev,next',
            center: 'title',
            right: 'today'
          },
          // 將抓到的 events 直接餵進去
          events: res.events, 
          
          // 點擊事件彈窗
          eventClick: function(info) {
              Swal.fire({
                title: info.event.title,
                text: info.event.startStr, // 顯示日期
                confirmButtonColor: '#db2777'
              });
          },
          
          // 解決切換 Tab 後可能破圖的問題
          windowResize: function(view) {
              calendarInstance.updateSize();
          }
        });

        // 渲染行事曆
        calendarInstance.render();
        
        // 強制再 resize 一次確保寬度正確
        setTimeout(() => {
            calendarInstance.updateSize();
        }, 100);
    })
    .catch(err => {
        console.error(err);
        showContentLoader(false);
        Swal.fire('系統錯誤', '行事曆載入失敗', 'error');
    });
}
